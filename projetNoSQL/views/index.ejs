<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Todo List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 40px auto;
      background: #fafafa;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      color: #333;
    }

    h1 {
      margin-bottom: 25px;
      color: #2c3e50;
    }

    form {
      margin-bottom: 30px;
    }

    input[type="text"] {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 10px;
    }
    .todo-input {
      width: 50%;
    }
    .tags-input {
      width: 20%;
    }

    button {
      padding: 10px 20px;
      background-color: #2980b9;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #1c5980;
    }

    ul {
      list-style-type: none;
      padding-left: 0;
    }

    li {
      background: white;
      margin-bottom: 10px;
      padding: 12px 15px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    li.done {
      text-decoration: line-through;
      color: gray;
    }

    .subtasks {
      margin-top: 10px;
      padding-left: 20px;
      width: 80%; /* moins large que le parent */
    }

    /* Sous-tâches plus petites */
    .subtasks li {
      background: #f5f5f5;
      margin-bottom: 6px;
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 0.75em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      /* largeur à 100% de la liste subtasks (donc 80% parent) */
      width: 100%;
      box-sizing: border-box;
    }

    .subtasks li.done {
      text-decoration: line-through;
      color: #999;
    }

    .tags {
      margin-top: 8px;
      font-size: 0.85em;
      color: #555;
    }

    .tag {
      background-color: #d1ecf1;
      color: #0c5460;
      padding: 2px 8px;
      border-radius: 12px;
      margin-right: 6px;
      display: inline-block;
    }

    .delete-btn {
      background-color: #e74c3c;
      border: none;
      color: white;
      border-radius: 3px;
      padding: 5px 9px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9em;
      margin-left: 10px;
      /* Le bouton sera bien aligné à droite grâce à flex */
      flex-shrink: 0; /* ne rétrécit pas */
    }
    .delete-btn:hover {
      background-color: #c0392b;
    }

    .logout {
      margin-bottom: 30px;
      text-align: right;
    }

    .logout a {
      color: #e74c3c;
      font-weight: bold;
      text-decoration: none;
    }
    .logout a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

  <div class="logout">
    <a href="/logout">Déconnexion</a>
  </div>

  <% if (isAuthenticated) { %>
        <div class="welcome-message">
            Bienvenue, <%= username %> !
        </div>
  <% } %>

  <h1>Ma Todo List</h1>

  <form method="POST" action="/">
    <input type="text" name="todoValue" placeholder="Nouvelle tâche" class="todo-input" required />
    <input type="text" name="tags" placeholder="Tags (séparés par des virgules)" class="tags-input" />
    <button type="submit">Ajouter</button>
  </form>

  <ul>
    <% data.forEach(todo => { %>
      <li class="<%= todo.done ? 'done' : '' %>" data-id="<%= todo._id %>">
        <div style="width: 100%;">
          <span><%= todo.todo %></span>

          <% if (todo.tags && todo.tags.length > 0) { %>
            <div class="tags">
              <% todo.tags.forEach(tag => { %>
                <span class="tag"><%= tag %></span>
              <% }) %>
            </div>
          <% } %>

          <form method="POST" action="/<%= todo._id %>/subtask" style="margin-top: 10px; margin-bottom: 10px;">
            <input type="text" name="subtaskTitle" placeholder="Nouvelle sous-tâche" required style="padding:5px 8px; width: 70%;" />
            <button type="submit" style="padding:5px 10px;">Ajouter</button>
          </form>

          <ul class="subtasks">
            <% todo.subtasks.forEach(sub => { %>
              <li class="<%= sub.done ? 'done' : '' %>" data-subtask-id="<%= sub._id %>">
                <span><%= sub.title %></span>
                <button class="delete-btn" data-subtask-id="<%= sub._id %>" data-todo-id="<%= todo._id %>">x</button>
              </li>
            <% }) %>
          </ul>
        </div>

        <button class="delete-btn" data-todo-id="<%= todo._id %>">Supprimer</button>
      </li>
    <% }) %>
  </ul>

  <script>
    async function deleteTodo(todoId) {
      const res = await fetch('/' + todoId, { method: 'DELETE' });
      if (res.ok) location.reload();
      else alert('Erreur lors de la suppression');
    }

    async function deleteSubtask(todoId, subtaskId) {
      const res = await fetch(`/${todoId}/subtask/${subtaskId}`, { method: 'DELETE' });
      if (res.ok) location.reload();
      else alert('Erreur lors de la suppression de la sous-tâche');
    }

    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        const todoId = btn.getAttribute('data-todo-id');
        const subtaskId = btn.getAttribute('data-subtask-id');

        if (subtaskId) {
          deleteSubtask(todoId, subtaskId);
        } else if (todoId) {
          deleteTodo(todoId);
        }
      });
    });
    
  </script>
</body>
</html>
